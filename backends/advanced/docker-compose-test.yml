# docker-compose-test.yml
# Test environment for integration tests
# Uses shared infrastructure (MongoDB:27017, Redis:6379, Qdrant:6333) with _test database names
# Only backend/webui use offset ports for parallel testing across worktrees
# Example: BLUE uses 8001/3001, GOLD uses 8011/3011

services:
  chronicle-backend-test:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${TEST_BACKEND_PORT:-8001}:8000"  # Default 8001, or 8000 + PORT_OFFSET + 1
    volumes:
      - ./src:/app/src  # Mount source code for easier development
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug_dir
      - ./data/test_data:/app/data
    environment:
      # Use shared infrastructure with _test database suffix for isolation
      - MONGODB_URI=mongodb://mongo:27017
      - MONGODB_DATABASE=${MONGODB_DATABASE:-chronicle}_test
      - QDRANT_BASE_URL=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379/${REDIS_DATABASE:-0}
      - DEBUG_DIR=/app/debug_dir
      # Import API keys from environment
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=https://api.openai.com/v1
      # LLM provider configuration (required for memory service)
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      # Authentication (test-specific)
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      # Transcription provider configuration
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      # Memory provider configuration
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      - MYCELIA_URL=http://mycelia-backend:5173
      - MYCELIA_DB=mycelia_${MONGODB_DATABASE:-chronicle}_test
      # Disable speaker recognition in test environment to prevent segment duplication
      - DISABLE_SPEAKER_RECOGNITION=false
      - SPEAKER_SERVICE_URL=https://localhost:8085
      - CORS_ORIGINS=http://localhost:${TEST_WEBUI_PORT:-3001},http://localhost:${TEST_BACKEND_PORT:-8001},https://localhost:${TEST_WEBUI_PORT:-3001},https://localhost:${TEST_BACKEND_PORT:-8001}
      # Set low inactivity timeout for tests (2 seconds instead of 60)
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=2
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/readiness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - chronicle-network

  webui-test:
    build:
      context: ./webui
      dockerfile: Dockerfile
      args:
        - VITE_BACKEND_URL=http://localhost:${TEST_BACKEND_PORT:-8001}
        - BACKEND_URL=http://localhost:${TEST_BACKEND_PORT:-8001}
    volumes:
      - ./webui/src:/app/src  # Mount source code for easier development
    ports:
      - "${TEST_WEBUI_PORT:-3001}:80"  # Default 3001, or 3000 + PORT_OFFSET + 1
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
    networks:
      - chronicle-network

  workers-test:
    build:
      context: .
      dockerfile: Dockerfile
    command: ./start-workers.sh
    volumes:
      - ./src:/app/src
      - ./data/test_audio_chunks:/app/audio_chunks
      - ./data/test_debug_dir:/app/debug_dir
      - ./data/test_data:/app/data
    environment:
      # Use shared infrastructure with _test database suffix for isolation
      - MONGODB_URI=mongodb://mongo:27017
      - MONGODB_DATABASE=${MONGODB_DATABASE:-chronicle}_test
      - QDRANT_BASE_URL=qdrant
      - QDRANT_PORT=6333
      - REDIS_URL=redis://redis:6379/${REDIS_DATABASE:-0}
      - DEBUG_DIR=/app/debug_dir
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - AUTH_SECRET_KEY=test-jwt-signing-key-for-integration-tests
      - ADMIN_PASSWORD=test-admin-password-123
      - ADMIN_EMAIL=test-admin@example.com
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-deepgram}
      - MEMORY_PROVIDER=${MEMORY_PROVIDER:-chronicle}
      - OPENMEMORY_MCP_URL=${OPENMEMORY_MCP_URL:-http://host.docker.internal:8765}
      - OPENMEMORY_USER_ID=${OPENMEMORY_USER_ID:-openmemory}
      - MYCELIA_URL=http://mycelia-backend:5173
      - MYCELIA_DB=mycelia_${MONGODB_DATABASE:-chronicle}_test
      - DISABLE_SPEAKER_RECOGNITION=false
      - SPEAKER_SERVICE_URL=https://localhost:8085
      # Set low inactivity timeout for tests (2 seconds instead of 60)
      - SPEECH_INACTIVITY_THRESHOLD_SECONDS=2
      # Wait for audio queue to drain before timing out (test mode)
      - WAIT_FOR_AUDIO_QUEUE_DRAIN=true
    depends_on:
      chronicle-backend-test:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - chronicle-network

# Shared network configuration
networks:
  chronicle-network:
    name: chronicle-network
    external: true

# Notes:
# - Tests use shared infrastructure (MongoDB:27017, Redis:6379, Qdrant:6333)
# - Database isolation via database names: {worktree}_test (e.g., chronicle_blue_test)
# - Redis isolation via database number from REDIS_DATABASE variable
# - Only backend/webui ports are offset for parallel testing
# - To run tests: ./run-test.sh (uses variables from .env.default)
