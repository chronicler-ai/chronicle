name: Robot Framework Tests

on:
  pull_request:
    paths:
      - 'tests/**/*.robot'
      - 'tests/**/*.py'
      - 'backends/advanced/src/**'
      - '.github/workflows/robot-tests.yml'

jobs:
  robot-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Robot Framework and dependencies
      run: |
        pip install --upgrade pip
        pip install robotframework robotframework-requests python-dotenv websockets

    - name: Create test environment file
      working-directory: tests/setup
      run: |
        cat > .env.test << EOF
        # API URLs
        API_URL=http://localhost:8001
        BACKEND_URL=http://localhost:8001
        FRONTEND_URL=http://localhost:3001

        # Test Admin Credentials
        ADMIN_EMAIL=test-admin@example.com
        ADMIN_PASSWORD=test-admin-password-123

        # API Keys (from GitHub secrets)
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        DEEPGRAM_API_KEY=${{ secrets.DEEPGRAM_API_KEY }}

        # Test Configuration
        TEST_TIMEOUT=120
        TEST_DEVICE_NAME=robot-test
        EOF

    - name: Start test environment
      working-directory: backends/advanced
      env:
        DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        LLM_PROVIDER: openai
        TRANSCRIPTION_PROVIDER: deepgram
        MEMORY_PROVIDER: friend_lite
      run: |
        # Debug: Check if secrets are available
        echo "Checking environment variables..."
        echo "DEEPGRAM_API_KEY is set: $([ -n "$DEEPGRAM_API_KEY" ] && echo 'YES' || echo 'NO')"
        echo "OPENAI_API_KEY is set: $([ -n "$OPENAI_API_KEY" ] && echo 'YES' || echo 'NO')"
        echo "LLM_PROVIDER: $LLM_PROVIDER"
        echo "TRANSCRIPTION_PROVIDER: $TRANSCRIPTION_PROVIDER"

        # Start infrastructure services with CI compose file (no src mounts)
        echo "Starting MongoDB, Redis, Qdrant, and RQ Workers..."
        DOCKER_BUILDKIT=1 docker compose -f docker-compose-ci.yml up -d --quiet-pull mongo-test redis-test qdrant-test workers-test 2>&1 | grep -v -E '(Preparing|Unpacking|Setting up|Selecting|processing|extracting)' || true

        # Show running containers
        docker compose -f docker-compose-ci.yml ps

        # Wait for MongoDB with better error handling
        echo "Waiting for MongoDB (up to 60s)..."
        for i in {1..30}; do
          if docker compose -f docker-compose-ci.yml exec -T mongo-test mongosh --eval "db.adminCommand({ping: 1})" > /dev/null 2>&1; then
            echo "‚úì MongoDB is ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚úó MongoDB failed to start"
            docker compose -f docker-compose-ci.yml logs mongo-test
            exit 1
          fi
          echo "Attempt $i/30..."
          sleep 2
        done

        # Wait for Qdrant with better error handling (uses port 6337 in test env)
        echo "Waiting for Qdrant (up to 60s)..."
        for i in {1..30}; do
          if curl -s http://localhost:6337/healthz > /dev/null 2>&1; then
            echo "‚úì Qdrant is ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚úó Qdrant failed to start"
            docker compose -f docker-compose-ci.yml logs qdrant-test
            exit 1
          fi
          echo "Attempt $i/30..."
          sleep 2
        done

        # Create memory_config.yaml from template (file is gitignored)
        echo "Creating memory_config.yaml from template..."
        cp memory_config.yaml.template memory_config.yaml
        ls -la memory_config.yaml

        # Start backend (depends on infrastructure)
        echo "Starting backend (forcing rebuild to include latest code)..."
        DOCKER_BUILDKIT=1 docker compose -f docker-compose-ci.yml build friend-backend-test 2>&1 | grep -v -E '(Preparing|Unpacking|Setting up|Selecting|processing|extracting)' || true

        # Debug: Check if file made it into the image
        echo "Checking if memory_config.yaml is in the built image..."
        docker compose -f docker-compose-ci.yml run --rm --no-deps friend-backend-test ls -la /app/memory_config.yaml || echo "File NOT in image!"

        docker compose -f docker-compose-ci.yml up -d friend-backend-test

        # Wait for backend to be ready
        echo "Waiting for backend (up to 120s)..."
        for i in {1..40}; do
          if curl -s http://localhost:8001/health > /dev/null 2>&1; then
            echo "‚úì Backend is ready"
            break
          fi
          # Show logs every 10 attempts to help debug
          if [ $((i % 10)) -eq 0 ]; then
            echo "Still waiting... showing recent logs:"
            docker compose -f docker-compose-ci.yml logs --tail=20 friend-backend-test
          fi
          if [ $i -eq 40 ]; then
            echo "‚úó Backend failed to start - showing full logs:"
            docker compose -f docker-compose-ci.yml logs friend-backend-test
            exit 1
          fi
          echo "Attempt $i/40..."
          sleep 3
        done

        echo "‚úì All services ready!"

    - name: Verify workers are running
      working-directory: backends/advanced
      run: |
        echo "Checking if workers-test container is running..."
        docker compose -f docker-compose-ci.yml ps workers-test

        # Check if workers container is actually running
        if ! docker compose -f docker-compose-ci.yml ps workers-test | grep -q "Up"; then
          echo "‚úó Workers container is not running! Showing logs:"
          docker compose -f docker-compose-ci.yml logs workers-test
          exit 1
        fi

        echo "‚úì Workers container is running"

        # Give workers a moment to register
        echo "Waiting 10 seconds for workers to register with Redis..."
        sleep 10

        echo ""
        echo "Checking RQ worker registration in Redis..."
        docker compose -f docker-compose-ci.yml exec -T workers-test uv run python -c "
        from rq import Worker
        from redis import Redis
        import os

        redis_url = os.getenv('REDIS_URL', 'redis://redis-test:6379/0')
        r = Redis.from_url(redis_url)
        workers = Worker.all(connection=r)

        print(f'Total registered workers: {len(workers)}')
        for worker in workers:
            print(f'  - {worker.name}: queues={worker.queue_names()}, state={worker.get_state()}')

        if len(workers) == 0:
            print('‚ö†Ô∏è WARNING: No workers registered!')
        " || echo "Failed to check worker registration"

        echo ""
        echo "Showing recent worker logs..."
        docker compose -f docker-compose-ci.yml logs --tail=30 workers-test

    - name: Run Robot Framework tests
      working-directory: tests
      env:
        # Required for backend imports in test libraries
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: https://api.openai.com/v1
        OPENAI_MODEL: gpt-4o-mini
        DEEPGRAM_API_KEY: ${{ secrets.DEEPGRAM_API_KEY }}
      run: |
        # Run all tests
        make all OUTPUTDIR=results || true

    - name: Show service logs
      if: always()
      working-directory: backends/advanced
      run: |
        echo "=== Backend Logs (last 50 lines) ==="
        docker compose -f docker-compose-ci.yml logs --tail=50 friend-backend-test
        echo ""
        echo "=== Worker Logs (last 50 lines) ==="
        docker compose -f docker-compose-ci.yml logs --tail=50 workers-test

    - name: Publish Robot Framework test results
      if: always()
      uses: joonvena/robotframework-reporter-action@v2.5
      with:
        report_path: tests/results
        gh_access_token: ${{ secrets.GITHUB_TOKEN }}
        show_passed_tests: false

    - name: Upload Robot Framework HTML reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-reports-html
        path: |
          tests/results/report.html
          tests/results/log.html
        retention-days: 30

    - name: Upload Robot Framework XML output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-results-xml
        path: tests/results/output.xml
        retention-days: 30

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-logs
        path: |
          backends/advanced/.env
          tests/setup/.env.test
        retention-days: 7

    - name: Display test results summary
      if: always()
      run: |
        if [ -f tests/results/output.xml ]; then
          echo "Test results generated successfully"
          echo "========================================"
          python3 << 'PYTHON_SCRIPT'
        import xml.etree.ElementTree as ET
        tree = ET.parse('tests/results/output.xml')
        root = tree.getroot()
        stats = root.find('.//total/stat')
        if stats is not None:
            passed = stats.get("pass", "0")
            failed = stats.get("fail", "0")
            print(f'‚úÖ Passed: {passed}')
            print(f'‚ùå Failed: {failed}')
            print(f'üìä Total: {int(passed) + int(failed)}')
        PYTHON_SCRIPT
          echo "========================================"
          echo ""
          echo "üìä FULL TEST REPORTS AVAILABLE:"
          echo "  1. Go to the 'Summary' tab at the top of this page"
          echo "  2. Scroll down to 'Artifacts' section"
          echo "  3. Download 'robot-test-reports-html'"
          echo "  4. Extract and open report.html or log.html in your browser"
          echo ""
          echo "The HTML reports provide:"
          echo "  - report.html: Executive summary with statistics"
          echo "  - log.html: Detailed step-by-step execution log"
          echo ""
        fi

    - name: Cleanup
      if: always()
      working-directory: backends/advanced
      run: |
        docker compose -f docker-compose-ci.yml down -v
